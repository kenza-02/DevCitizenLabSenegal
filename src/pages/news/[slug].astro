---
import Layout from "~/layouts/PageLayout.astro";
import { getActualiteBySlug, getActualites } from "~/utils/api";
import { GoArrowUpRight } from "react-icons/go";

const { slug } = Astro.params;

// Extraire le vrai slug depuis l'URL WordPress (format: YYYY/MM/DD/slug/)
const slugParts = Array.isArray(slug) ? slug : [slug];
const realSlug = slugParts[slugParts.length - 1]; // Prendre le dernier élément (le slug réel)

// Récupérer l'article depuis l'API en utilisant le slug réel
const article = await getActualiteBySlug(realSlug);

if (!article) {
  throw new Error("Article introuvable");
}

// Récupérer d'autres articles pour la section "Autres articles"
const autresArticles = await getActualites();

// Transformer les données des autres articles
const autresArticlesTransformes = autresArticles
  .filter((art) => art.uri !== article.uri) // Filtrer l'article actuel
  .slice(0, 3)
  .map((art) => ({
    slug: art.uri.replace('/', ''),
    data: {
      title: art.title,
      date: new Date(art.date).toLocaleDateString('fr-FR'),
      category: art.categories?.nodes?.[0]?.name || 'Actualités',
      image: art.featuredImage?.node?.mediaItemUrl || '/images/news.jpg',
    },
  }));
---

<Layout
  metadata={{ title: article.title || 'Article' }}
>
  <main class="mx-auto py-16 bg-[#fcfcfc]">
    <div class="max-w-4xl mx-auto text-center mb-12 space-y-6">
      <span
        class="text-base font-semibold text-green-900 mb-2 border border-green-900 px-4 py-3 rounded-full"
        >{article.categories?.nodes?.[0]?.name || 'Actualités'}</span
      >
      <h2 class="text-5xl font-bold mb-6 text-green-900">
        {article.title}
      </h2>
      <p class="text-sm text-center text-green-900 mb-8">
        • Publié le {
          new Date(article.date).toLocaleDateString("fr-FR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }
      </p>
    </div>

    <div class="max-w-4xl mx-auto mb-12">
    {
      article.featuredImage?.node?.sourceUrl && (
        <div class="mb-8">
          <img
            src={article.featuredImage.node.sourceUrl}
            alt={article.featuredImage.node.altText || article.title}
            class="w-full h-auto rounded-lg"
          />
        </div>
      )
    }
    <!-- Contenu de l'article -->
      <article class="prose prose-lg prose-green max-w-none
        prose-headings:text-green-900 prose-headings:font-bold
        prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
        prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
        prose-ul:my-6 prose-ul:space-y-3
        prose-li:text-gray-700
        prose-strong:text-green-900 prose-strong:font-semibold
      " set:html={article.content} />
    </div>
  </main>
    <div class="mx-auto bg-[#f0f2ee] py-12 px-10">
        <h3 class="text-green-900 text-3xl font-bold">Autres articles</h3>
        <!-- Grille de cards -->
        <div class="py-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="cards-grid">
            {autresArticlesTransformes.map((article) => (
            <a href={`/news/${article.slug}`} class="block group">
                <article
                class="news-card bg-white rounded-3xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-500 cursor-pointer"
                data-category={article.data.category}
                >
                <!-- Image -->
                <div class="relative h-72 overflow-hidden px-4">
                    <img
                    src={article.data.image}
                    alt={article.data.title}
                    class="w-full rounded-xl h-full object-cover group-hover:scale-110 transition-transform duration-700"
                    />
                </div>

                <!-- Contenu -->
                <div class="p-8">
                    <span class="inline-block text-xs font-semibold text-gray-700 uppercase tracking-wider mb-4">
                    {article.data.category} • {article.data.date}
                    </span>

                    <h3 class="text-xl font-semibold text-green-700 mb-6 leading-snug min-h-[120px]">
                    {article.data.title}
                    </h3>

                    <!-- Bouton remplacé par un simple div pour garder le design -->
                    <div class="flex justify-end">
                    <div
                        class="inline-flex items-center justify-center w-12 h-12 bg-green-50 group-hover:bg-green-700 rounded-full transition-all duration-300"
                        aria-hidden="true"
                    >
                        <GoArrowUpRight className="w-5 h-5 text-green-600 group-hover:text-white" />
                    </div>
                    </div>
                </div>
                </article>
            </a>
            ))}

        </div>
        </div>
    </div>
</Layout>
